name: Tensorflow zephyr-vexriscv tests
on: [push,pull_request,workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-18.04
    env:
      ZEPHYR_TOOLCHAIN_VARIANT: "zephyr"
      ZEPHYR_SDK_INSTALL_DIR: "/opt/zephyr-sdk"
      DEMO_HOME: "${{ github.workspace }}"
      TENSORFLOW_PATH: "${{ github.workspace }}/tensorflow"
    steps:
      - name: Configure git
        run: git config --global url.https://github.com/llvm-mirror/.insteadOf 'https://git.llvm.org/git/'
     
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Set Up Python
        uses: actions/setup-python@v2

      - name: Install requirements
        run: |
          ./install_dependencies.sh

      - name: Build magic-wand binary
        run: |
          ./build.sh magic_wand

      - name: Test magic-wand in Renode
        uses: antmicro/renode-actions/test-in-renode@main
        with:
          tests-to-run: 'examples/magic-wand/magic_wand.robot'

      - name: Upload magic-wand artifacts
        uses: actions/upload-artifact@v2
        with:
          name: magic_wand_artifacts
          path: |
            tensorflow/tensorflow/lite/micro/tools/make/gen/zephyr_vexriscv_x86_64_default/magic_wand/build/zephyr/zephyr.elf

      - name: Build hello-world binary
        run: |
          ./build.sh hello_world

      - name: Test hello-world in Renode
        uses: antmicro/renode-actions/test-in-renode@main
        with:
          tests-to-run: 'examples/hello-world/hello_world.robot'

      - name: Upload hello-world artifacts
        uses: actions/upload-artifact@v2
        with:
          name: hello_world_artifacts
          path: |
            tensorflow/tensorflow/lite/micro/tools/make/gen/zephyr_vexriscv_x86_64_default/hello_world/build/zephyr/zephyr.elf
